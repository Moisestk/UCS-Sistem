{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear cuenta | Sistema de Registro de Proyectos UCS</title>
    <link rel="icon" type="image/x-icon" href="{% static 'img/mini.ico' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ucs-red': '#CE1919',
                        'ucs-gold': '#F0B97A',
                        'ucs-black': '#1a1a1a',
                        'ucs-gray': '#f8f9fa'
                    }
                }
            }
        }
    </script>
    <style>
        :root { --ucs-red:#CE1919; --ucs-gold:#F0B97A; --ucs-dark:#1f2937; --ucs-gray:#f8f9fa; }
        body { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
        .shake { animation: shake .5s ease-in-out 2; }
        .form-input { transition:all .3s ease; border:2px solid #e5e7eb; }
        .form-input:focus { border-color: var(--ucs-red); box-shadow:0 0 0 3px rgba(206,25,25,.1); outline:none; }
        
        /* Ocultar mensaje rojo de reCAPTCHA de prueba */
        .grecaptcha-badge { visibility: hidden !important; }
        iframe[src*="recaptcha"] { filter: none !important; }
        div[style*="color: rgb(204, 0, 0)"] { display: none !important; }
        .g-recaptcha div[style*="color: rgb(204, 0, 0)"],
        .g-recaptcha div[style*="color: #cc0000"] { display: none !important; }
        .btn-primary { background:linear-gradient(135deg, var(--ucs-red) 0%, #b91c1c 100%); transition:all .3s ease; }
        .btn-primary:hover { transform:translateY(-2px); box-shadow:0 10px 25px rgba(206,25,25,.3); }
        .card-shadow { box-shadow:0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04); }
        .step-indicator { background:linear-gradient(135deg, var(--ucs-red) 0%, #b91c1c 100%); }
        .avatar-preview { transition:all .3s ease; }
        .avatar-preview:hover { transform:scale(1.05); }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="{% url 'home' %}" class="flex items-center space-x-3 hover:opacity-80 transition-opacity">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/7/74/Logo_de_la_Universidad_Ciencias_de_la_Salud.png" alt="UCS Logo" class="h-12 w-auto">
                    <div class="flex flex-col">
                        <span class="text-lg font-bold text-ucs-red">Sistema de Registro de Proyectos</span>
                        <span class="text-sm text-gray-600">Universidad de las Ciencias de la Salud</span>
                    </div>
                </a>
                <a href="/login/" class="text-ucs-red hover:text-red-700 font-medium transition-colors">
                    <i class="fas fa-sign-in-alt mr-2"></i>Ingresar
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-2xl card-shadow overflow-hidden">
            <div class="bg-gradient-to-r from-ucs-red to-red-700 px-8 py-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold mb-2">Crear cuenta</h1>
                        <p class="text-red-100">Registro en dos pasos. Completa toda la información requerida.</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        {% if step == '2' %}
                            <div class="step-indicator w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-white text-ucs-red">1</div>
                            <div class="w-8 h-0.5 bg-white"></div>
                            <div class="step-indicator w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">2</div>
                        {% else %}
                            <div class="step-indicator w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">1</div>
                            <div class="w-8 h-0.5 bg-red-300"></div>
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-red-300 text-red-600">2</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if step == '2' %}
            <form method="POST" enctype="multipart/form-data" class="p-8">
                {% csrf_token %}
                <input type="hidden" name="step" value="2" />

                {% if form2.non_field_errors %}
                    <div class="mb-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-700">
                        <i class="fas fa-exclamation-triangle mr-2"></i>{{ form2.non_field_errors }}
                    </div>
                {% endif %}

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-user mr-2 text-ucs-red"></i>Cedula de Identidad (Usuario) 
                        </label>
                        <input
                            class="form-input w-full px-4 py-3 rounded-lg"
                            type="text"
                            name="username"
                            value="{{ form2.username.value|default:'' }}"
                            placeholder="Ingresa tu cédula (7 u 8 dígitos)"
                            required
                            pattern="^\d{7,8}$"
                            minlength="7"
                            maxlength="8"
                            inputmode="numeric"
                            title="Solo números, 7 u 8 dígitos"
                        />
                        {% if form2.username.errors %}
                            <div class="mt-2 text-sm text-red-600">
                                <i class="fas fa-exclamation-circle mr-1"></i>{{ form2.username.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="bg-gray-50 rounded-xl p-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">
                            <i class="fas fa-camera mr-2 text-ucs-red"></i>Foto de perfil (opcional)
                        </label>
                        <div class="flex items-center space-x-6">
                            <div class="avatar-preview w-24 h-24 rounded-full border-4 border-ucs-gold bg-gray-100 overflow-hidden shadow-lg">
                                <img id="avatarPreview" class="w-full h-full object-cover" src="{% static 'img/user.png' %}" alt="Preview" />
                            </div>
                            <div class="flex-1">
                                <input class="form-input w-full px-4 py-3 rounded-lg" type="file" name="photo" accept="image/*" id="avatarInput" />
                                {% if form2.photo and form2.photo.errors %}
                                    <div class="mt-2 text-sm text-red-600">
                                        <i class="fas fa-exclamation-circle mr-1"></i>{{ form2.photo.errors|striptags }}
                                    </div>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>Formatos soportados: JPG, PNG. Tamaño recomendado: 256x256px
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- reCAPTCHA para el segundo paso -->
                    <div class="bg-blue-50 rounded-xl p-6 border border-blue-200">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">
                            <i class="fas fa-shield-alt mr-2 text-blue-600"></i>Verificación de seguridad
                        </label>
                        <div class="flex justify-center">
                            {{ form2.captcha }}
                        </div>
                        <div class="mt-3 text-sm text-gray-600 text-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Marca la casilla "No soy un robot" para continuar
                        </div>
                        {% if form2.captcha.errors %}
                            <div class="mt-3 text-sm text-red-600 text-center">
                                <i class="fas fa-exclamation-circle mr-1"></i>{{ form2.captcha.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="flex items-center justify-between pt-4">
                        <a href="/register/" class="text-gray-600 hover:text-ucs-red font-medium transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Volver al paso 1
                        </a>
                        <button type="submit" class="btn-primary px-8 py-3 text-white rounded-lg font-semibold">
                            <i class="fas fa-user-plus mr-2"></i>Crear cuenta
                        </button>
                    </div>
                </div>
            </form>
            {% else %}
            <form method="POST" class="p-8">
                {% csrf_token %}
                <input type="hidden" name="step" value="1" />

                {% if form1 and form1.non_field_errors %}
                    <div class="mb-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-700">
                        <i class="fas fa-exclamation-triangle mr-2"></i>{{ form1.non_field_errors }}
                    </div>
                {% endif %}

                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-user mr-2 text-ucs-red"></i>Nombre
                            </label>
                            <input class="form-input w-full px-4 py-3 rounded-lg" type="text" name="first_name" value="{{ form1.first_name.value|default:'' }}" placeholder="Tu nombre" required />
                            {% if form1.first_name.errors %}
                                <div class="mt-2 text-sm text-red-600">
                                    <i class="fas fa-exclamation-circle mr-1"></i>{{ form1.first_name.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-user mr-2 text-ucs-red"></i>Apellido
                            </label>
                            <input class="form-input w-full px-4 py-3 rounded-lg" type="text" name="last_name" value="{{ form1.last_name.value|default:'' }}" placeholder="Tu apellido" required />
                            {% if form1.last_name.errors %}
                                <div class="mt-2 text-sm text-red-600">
                                    <i class="fas fa-exclamation-circle mr-1"></i>{{ form1.last_name.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-envelope mr-2 text-ucs-red"></i>Correo electrónico
                        </label>
                        <input class="form-input w-full px-4 py-3 rounded-lg" type="email" name="email" value="{{ form1.email.value|default:'' }}" placeholder="tu@email.com" required />
                        {% if form1.email.errors %}
                            <div class="mt-2 text-sm text-red-600">
                                <i class="fas fa-exclamation-circle mr-1"></i>{{ form1.email.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-lock mr-2 text-ucs-red"></i>Contraseña
                            </label>
                            <div class="relative">
                                <input class="form-input w-full px-4 py-3 rounded-lg pr-12" type="password" name="password1" id="regPassword1" placeholder="Mínimo 8 caracteres" required />
                                <button type="button" id="toggleRegPwd1" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500" aria-label="Mostrar u ocultar contraseña">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-lock mr-2 text-ucs-red"></i>Confirmar contraseña
                            </label>
                            <div class="relative">
                                <input class="form-input w-full px-4 py-3 rounded-lg pr-12" type="password" name="password2" id="regPassword2" placeholder="Repite tu contraseña" required />
                                <button type="button" id="toggleRegPwd2" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500" aria-label="Mostrar u ocultar contraseña">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                        La contraseña debe tener mínimo 8 caracteres e incluir mayúsculas, minúsculas y números.
                    </div>

                    <div class="bg-blue-50 rounded-xl p-6 border border-blue-200">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">
                            <i class="fas fa-shield-alt mr-2 text-blue-600"></i>Verificación de seguridad
                        </label>
                        <div class="flex justify-center">
                            {{ form1.captcha }}
                        </div>
                        <div class="mt-3 text-sm text-gray-600 text-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Marca la casilla "No soy un robot" para continuar
                        </div>
                        {% if form1.captcha.errors %}
                            <div class="mt-3 text-sm text-red-600 text-center">
                                <i class="fas fa-exclamation-circle mr-1"></i>{{ form1.captcha.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="flex items-center justify-between pt-4">
                        <a href="/login/" class="text-gray-600 hover:text-ucs-red font-medium transition-colors">
                            <i class="fas fa-sign-in-alt mr-2"></i>Ya tengo una cuenta
                        </a>
                        <button type="submit" class="btn-primary px-8 py-3 text-white rounded-lg font-semibold">
                            <i class="fas fa-arrow-right mr-2"></i>Continuar
                        </button>
                    </div>
                </div>
            </form>
            {% endif %}
        </div>
    </main>

    <footer class="bg-gray-100 border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-center space-x-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/7/74/Logo_de_la_Universidad_Ciencias_de_la_Salud.png" alt="UCS Logo" class="h-8 w-auto">
                <span class="text-gray-600 text-sm">© 2024 Universidad de las Ciencias de la Salud "Hugo Chávez Frías"</span>
            </div>
        </div>
    </footer>

    <script>
        // Previsualización de avatar
        (function () {
            const fileInput = document.getElementById('avatarInput');
            const defaultSrc = "{% static 'img/user.png' %}";
            let img = document.getElementById('avatarPreview');
            let circle = null;
            if (!img) {
                const candidates = document.querySelectorAll('*');
                for (const el of candidates) {
                    const txt = (el.textContent || '').trim().toLowerCase();
                    if (txt === 'preview') { circle = el; break; }
                }
                if (circle) {
                    circle.style.backgroundImage = `url("${defaultSrc}")`;
                    circle.style.backgroundSize = 'cover';
                    circle.style.backgroundPosition = 'center';
                    circle.style.backgroundRepeat = 'no-repeat';
                    circle.style.color = 'transparent';
                }
            } else {
                if (!img.getAttribute('src')) img.setAttribute('src', defaultSrc);
            }

            if (!fileInput) return;

            fileInput.addEventListener('change', () => {
                const file = fileInput.files && fileInput.files[0];
                if (!file) {
                    if (img) {
                        img.src = defaultSrc;
                        img.parentElement?.classList.remove('ring-4', 'ring-ucs-red');
                    } else if (circle) {
                        circle.style.backgroundImage = `url("${defaultSrc}")`;
                        circle.style.color = 'transparent';
                    }
                    return;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    const src = e.target.result;
                    if (img) {
                        img.src = src;
                        img.parentElement?.classList.add('ring-4', 'ring-ucs-red');
                    } else if (circle) {
                        circle.style.backgroundImage = `url("${src}")`;
                        circle.style.color = 'transparent';
                    }
                };
                reader.readAsDataURL(file);
            });
        })();


        // Ver/ocultar contraseñas
        (function() {
            function attachToggle(btnId, inputId) {
                const btn = document.getElementById(btnId);
                const input = document.getElementById(inputId);
                if (!btn || !input) return;
                btn.addEventListener('click', () => {
                    const eye = btn.querySelector('i');
                    if (input.type === 'password') {
                        input.type = 'text';
                        eye.classList.remove('fa-eye'); eye.classList.add('fa-eye-slash');
                    } else {
                        input.type = 'password';
                        eye.classList.remove('fa-eye-slash'); eye.classList.add('fa-eye');
                    }
                });
            }
            attachToggle('toggleRegPwd1', 'regPassword1');
            attachToggle('toggleRegPwd2', 'regPassword2');
        })();

        // Animación simple de entrada
        document.addEventListener('DOMContentLoaded', () => {
            const elements = document.querySelectorAll('.form-input, .btn-primary');
            elements.forEach((el, index) => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    el.style.transition = 'all 0.6s ease';
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, index * 100);
            });

            // Ocultar mensaje rojo de reCAPTCHA cuando aparezca
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        const redMessages = document.querySelectorAll('div[style*="color: rgb(204, 0, 0)"], div[style*="color: #cc0000"]');
                        redMessages.forEach(msg => {
                            if (msg.textContent.includes('testing purposes') || msg.textContent.includes('This reCAPTCHA is for testing')) {
                                msg.style.display = 'none';
                            }
                        });
                    }
                });
            });

            // Observar cambios en el contenedor de reCAPTCHA
            const recaptchaContainer = document.querySelector('.g-recaptcha');
            if (recaptchaContainer) {
                observer.observe(recaptchaContainer, { childList: true, subtree: true });
            }

            // También observar el body por si el mensaje aparece fuera del contenedor
            observer.observe(document.body, { childList: true, subtree: true });
        });
    </script>
</body>
</html>