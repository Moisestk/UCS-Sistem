{% extends 'panel/base.html' %}
{% block title %}Usuarios | Sistema UCS{% endblock %}
{% block content %}
<div class="mb-6 sm:mb-8">
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-4 sm:space-y-0">
    <div>
      <h2 class="text-2xl sm:text-3xl font-bold text-ucs-red flex items-center">
        <i class="fas fa-users mr-2 sm:mr-3"></i>Gestión de Usuarios
      </h2>
      <p class="text-sm sm:text-base text-gray-600 mt-1 sm:mt-2">Administra las cuentas de usuarios del sistema</p>
    </div>

    <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
      {% with role=user.profile.role|default:'ESTUDIANTE' %}
        {% if user.is_superuser or role == 'ADMIN' %}
          <a href="{% url 'panel:users_create' %}"
             class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-ucs-red border border-ucs-red rounded-lg hover:bg-red-700 hover:border-red-700 transition-all">
            <i class="fas fa-user-plus mr-2"></i>
            Añadir Usuario
          </a>
        {% endif %}
      {% endwith %}

      <a href="{% url 'panel:users_trash_list' %}" 
         class="inline-flex items-center px-4 py-2 text-sm font-medium text-orange-700 bg-orange-50 border border-orange-200 rounded-lg hover:bg-orange-100 hover:text-orange-800 transition-all">
        <i class="fas fa-trash mr-2"></i>
        Papelera
        {% if users_trash_count > 0 %}
        <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-orange-200 text-orange-800 rounded-full">
          {{ users_trash_count }}
        </span>
        {% endif %}
      </a>
    </div>
  </div>
</div>

<!-- Filtros de búsqueda -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-4 sm:mb-6">
  <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200">
    <h3 class="text-gray-900 font-semibold flex items-center text-sm sm:text-base">
      <i class="fas fa-filter mr-2 text-ucs-red"></i>Filtros de Búsqueda
    </h3>
  </div>
  <form method="get" class="p-4 sm:p-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-3 sm:mb-4">
      <div>
        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
          <i class="fas fa-user mr-1 text-ucs-red"></i>Nombre
        </label>
        <input type="text" name="nombre" placeholder="Buscar por nombre" value="{{ filters.nombre }}"
               class="w-full border-2 border-gray-200 rounded-lg px-3 sm:px-4 py-2 sm:py-3 text-sm focus:border-ucs-red focus:ring-2 focus:ring-red-100 transition-all" />
      </div>
      <div>
        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
          <i class="fas fa-id-card mr-1 text-ucs-red"></i>Cédula
        </label>
        <input type="text" name="cedula" placeholder="Buscar por cédula" value="{{ filters.cedula }}"
               class="w-full border-2 border-gray-200 rounded-lg px-3 sm:px-4 py-2 sm:py-3 text-sm focus:border-ucs-red focus:ring-2 focus:ring-red-100 transition-all" />
      </div>
      <div class="sm:col-span-2">
        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
          <i class="fas fa-search mr-1 text-ucs-red"></i>Búsqueda General
        </label>
        <input type="text" name="q" placeholder="Usuario, nombre o email" value="{{ filters.q }}"
               class="w-full border-2 border-gray-200 rounded-lg px-3 sm:px-4 py-2 sm:py-3 text-sm focus:border-ucs-red focus:ring-2 focus:ring-red-100 transition-all" />
      </div>
    </div>
    <div class="flex justify-end">
      <button type="submit" class="bg-ucs-red hover:bg-red-700 text-white px-4 sm:px-6 py-2 rounded-lg transition-colors flex items-center text-sm">
        <i class="fas fa-search mr-2"></i>Filtrar
      </button>
    </div>
  </form>
</div>

<!-- Tabla de usuarios -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
  <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200">
    <h3 class="text-gray-900 font-semibold flex items-center text-sm sm:text-base">
      <i class="fas fa-table mr-2 text-ucs-red"></i>Lista de Usuarios
    </h3>
  </div>
  
  <div class="overflow-x-auto">
    <table class="min-w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden sm:table-cell">
            <i class="fas fa-hashtag mr-1"></i>ID
          </th>
          <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            <i class="fas fa-user mr-1"></i>Usuario
          </th>
          <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden md:table-cell">
            <i class="fas fa-id-badge mr-1"></i>Nombre
          </th>
          <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden lg:table-cell">
            <i class="fas fa-envelope mr-1"></i>Email
          </th>
          <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            <i class="fas fa-user-shield mr-1"></i>Rol
          </th>
          <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden sm:table-cell">
            <i class="fas fa-toggle-on mr-1"></i>Estado
          </th>
          <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            <i class="fas fa-cogs mr-1"></i>Acciones
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for u in page_obj.object_list %}
        <tr class="hover:bg-gray-50 transition-colors duration-200">
          <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900 hidden sm:table-cell">#{{ u.id }}</td>
          <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="h-8 w-8 sm:h-10 sm:w-10 rounded-full bg-ucs-red text-white flex items-center justify-center font-semibold mr-2 sm:mr-3 text-xs sm:text-sm">
                {{ u.username|first|upper }}
              </div>
              <div class="min-w-0 flex-1">
                <div class="text-xs sm:text-sm font-medium text-gray-900 truncate">{{ u.username }}</div>
                <div class="text-xs text-gray-500 sm:hidden">#{{ u.id }}</div>
                <div class="text-xs text-gray-500 md:hidden">{{ u.first_name|default:"—" }} {{ u.last_name|default:"" }}</div>
              </div>
            </div>
          </td>
          <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 hidden md:table-cell">
            {{ u.first_name|default:"—" }} {{ u.last_name|default:"" }}
          </td>
          <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-600 hidden lg:table-cell">
            {{ u.email|default:"—"|truncatechars:20 }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            {% with role=u.profile.role|default_if_none:''|default:'' %}
              {% if role %}
                {% if role == 'ADMIN' %}
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800">
                    <i class="fas fa-crown mr-1"></i>ADMIN
                  </span>
                {% else %}
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">
                    <i class="fas fa-user-graduate mr-1"></i>ESTUDIANTE
                  </span>
                {% endif %}
              {% else %}
                {% if u.is_superuser or u.is_staff %}
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800">
                    <i class="fas fa-crown mr-1"></i>ADMIN
                  </span>
                {% else %}
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">
                    <i class="fas fa-user-graduate mr-1"></i>ESTUDIANTE
                  </span>
                {% endif %}
              {% endif %}
            {% endwith %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            {% if u.is_active %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <i class="fas fa-check-circle mr-1"></i>Activo
              </span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                <i class="fas fa-times-circle mr-1"></i>Inactivo
              </span>
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <div class="flex items-center space-x-2">
              <!-- Editar (abre modal) -->
              <button type="button"
                      class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors duration-200 flex items-center"
                      onclick="openEditModal({{ u.id }})">
                <i class="fas fa-edit mr-1"></i>Editar
              </button>

              <!-- Suspender / Activar -->
              <form method="post" action="{% url 'panel:user_action' u.id %}" class="inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="{% if u.is_active %}suspend{% else %}activate{% endif %}" />
                <button type="submit"
                        class="{% if u.is_active %}bg-yellow-500 hover:bg-yellow-600{% else %}bg-blue-600 hover:bg-blue-700{% endif %} text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors duration-200 flex items-center">
                  {% if u.is_active %}
                    <i class="fas fa-pause mr-1"></i>Suspender
                  {% else %}
                    <i class="fas fa-play mr-1"></i>Activar
                  {% endif %}
                </button>
              </form>

              <!-- Enviar a papelera -->
              {% if not u.is_staff and not u.is_superuser and u.id != request.user.id %}
              <form method="post" action="{% url 'panel:user_action' u.id %}" class="inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete" />
                <button type="button"
                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors duration-200 flex items-center"
                        onclick="showDeleteModal('{{ u.username }}', '{{ u.id }}')">
                  <i class="fas fa-trash mr-1"></i>Papelera
                </button>
              </form>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="px-6 py-12 text-center">
            <div class="flex flex-col items-center">
              <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
              <h3 class="text-lg font-medium text-gray-900 mb-2">No hay usuarios</h3>
              <p class="text-gray-500">No se encontraron usuarios con los filtros aplicados.</p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  {% if page_obj.paginator.num_pages > 1 %}
  <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
    <div class="flex items-center justify-between">
      <div class="text-sm text-gray-600">
        <i class="fas fa-info-circle mr-1"></i>
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        ({{ page_obj.paginator.count }} usuarios total)
      </div>
      <div class="flex space-x-2">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}"
             class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">
            <i class="fas fa-chevron-left mr-1"></i>Anterior
          </a>
        {% endif %}
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}"
             class="bg-ucs-red text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
            Siguiente<i class="fas fa-chevron-right ml-1"></i>
          </a>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Modal de confirmación eliminar/papelera -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900 flex items-center">
        <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>
        Confirmar Acción
      </h3>
    </div>
    <div class="p-6">
      <p class="text-gray-600 mb-4">
        ¿Estás seguro de enviar el usuario <strong id="deleteUsername"></strong> a la papelera?
      </p>
      <p class="text-sm text-gray-500">
        Esta acción se puede revertir desde la papelera.
      </p>
    </div>
    <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
      <button type="button" onclick="hideDeleteModal()"
              class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
        Cancelar
      </button>
      <button type="button" onclick="confirmDelete()"
              class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
        Enviar a Papelera
      </button>
    </div>
  </div>
</div>

<!-- Modal de edición de usuario -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">
        <i class="fas fa-user-cog mr-2 text-indigo-600"></i>Editar usuario
      </h3>
    </div>
    <form id="editForm" method="post">
      {% csrf_token %}
      <div class="p-6 space-y-4">
        <input type="hidden" id="editUserId" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
            <input id="first_name" class="w-full border-2 border-gray-200 rounded-lg px-4 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
            <input id="last_name" class="w-full border-2 border-gray-200 rounded-lg px-4 py-2">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input id="email" type="email" class="w-full border-2 border-gray-200 rounded-lg px-4 py-2">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
          <label class="inline-flex items-center space-x-2">
            <input id="is_active" type="checkbox" class="h-4 w-4 text-green-600">
            <span class="text-sm text-gray-700">Activo</span>
          </label>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Rol</label>
            <select id="role" class="w-full border-2 border-gray-200 rounded-lg px-3 py-2">
              <option value="ESTUDIANTE">ESTUDIANTE</option>
              <option value="ADMIN">ADMIN</option>
            </select>
          </div>
        </div>
      </div>
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
        <button type="button" onclick="hideEditModal()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200">Cancelar</button>
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Guardar</button>
      </div>
    </form>
  </div>
</div>

<style>
  .table-row-hover:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  button:hover { transform: translateY(-1px); }
  input:focus { transform: scale(1.02); }
  #deleteModal.show, #editModal.show { display: flex !important; animation: fadeIn 0.3s ease-out; }
  #deleteModal.show > div, #editModal.show > div { animation: slideIn 0.3s ease-out; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideIn { from { transform: scale(0.9) translateY(-20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
</style>

<script>
  // Utilidades scroll
  function lockScroll() { document.documentElement.style.overflow = 'hidden'; document.body.style.overflow = 'hidden'; }
  function unlockScroll() { document.documentElement.style.overflow = ''; document.body.style.overflow = ''; }

  // Papelera
  let currentUserId = null;
  function showDeleteModal(username, userId) {
    currentUserId = userId;
    const modal = document.getElementById('deleteModal');
    const labelEl = document.getElementById('deleteUsername');
    if (labelEl) labelEl.textContent = username;
    if (modal) { modal.classList.remove('hidden'); modal.classList.add('show'); lockScroll(); }
  }
  function hideDeleteModal() {
    const modal = document.getElementById('deleteModal');
    if (modal) { modal.classList.remove('show'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }
    currentUserId = null; unlockScroll();
  }
  function confirmDelete() {
    if (currentUserId) {
      const deleteInput = document.querySelector(
        `form[action*="/${currentUserId}/accion/"] input[name="action"][value="delete"]`
      );
      const deleteForm = deleteInput ? deleteInput.closest('form') : null;
      if (deleteForm) deleteForm.submit();
    }
    hideDeleteModal();
  }
  const deleteModalEl = document.getElementById('deleteModal');
  if (deleteModalEl) deleteModalEl.addEventListener('click', e => { if (e.target === deleteModalEl) hideDeleteModal(); });

  // Edición
  let editUserId = null;
  function getCsrfToken() { const el = document.querySelector('input[name=csrfmiddlewaretoken]'); return el ? el.value : ''; }

  async function openEditModal(userId) {
    editUserId = userId;
    const modal = document.getElementById('editModal');
    try {
      const res = await fetch(`{% url 'panel:user_get' 0 %}`.replace('/0/', `/${userId}/`));
      const data = await res.json();
      if (data && data.ok) {
        const u = data.user || {};
        const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val ?? ''; };
        const setCheck = (id, checked) => { const el = document.getElementById(id); if (el) el.checked = !!checked; };

        setVal('editUserId', u.id);
        setVal('first_name', u.first_name);
        setVal('last_name', u.last_name);
        setVal('email', u.email);
        setCheck('is_active', u.is_active);
        const roleSel = document.getElementById('role'); if (roleSel) roleSel.value = u.role || 'ESTUDIANTE';

        if (modal) { modal.classList.remove('hidden'); modal.classList.add('show'); lockScroll(); }
      } else { alert('No se pudo cargar el usuario.'); }
    } catch { alert('No se pudo cargar el usuario.'); }
  }
  function hideEditModal() {
    const modal = document.getElementById('editModal');
    if (modal) { modal.classList.remove('show'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }
    editUserId = null; unlockScroll();
  }

  const editFormEl = document.getElementById('editForm');
  if (editFormEl) {
    editFormEl.addEventListener('submit', async function (e) {
      e.preventDefault(); if (!editUserId) return;
      const fd = new FormData();
      const gv = id => (document.getElementById(id)?.value ?? '');
      const gc = id => (document.getElementById(id)?.checked ? '1' : '0');
      fd.append('first_name', gv('first_name'));
      fd.append('last_name', gv('last_name'));
      fd.append('email', gv('email'));
      fd.append('is_active', gc('is_active'));
      fd.append('role', gv('role'));
      fd.append('csrfmiddlewaretoken', getCsrfToken());

      try {
        const res = await fetch(`{% url 'panel:user_update' 0 %}`.replace('/0/', `/${editUserId}/`), {
          method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: fd
        });
        const ct = res.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          const data = await res.json();
          if (data && data.ok) { window.location.reload(); return; }
        }
        window.location.reload();
      } catch { alert('Error al guardar.'); }
    });
  }

  // Cerrar con clic fuera y con ESC
  const editModalEl = document.getElementById('editModal');
  if (editModalEl) editModalEl.addEventListener('click', e => { if (e.target === editModalEl) hideEditModal(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') { hideDeleteModal(); hideEditModal(); } });
</script>
{% endblock %}